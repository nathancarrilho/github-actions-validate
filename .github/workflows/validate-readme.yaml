# .github/workflows/validar-readme.yml

name: ValidaÃ§Ã£o do README.md ğŸ“„

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  validar_conteudo_readme:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš€ Checkout do RepositÃ³rio
        uses: actions/checkout@v4

      - name: âœ… Validar se o README.md contÃ©m o nome do repositÃ³rio
        id: check_repo_name
        run: |
          REPO_NAME="${{ github.event.repository.name }}"
          echo "A verificar se o README.md contÃ©m o nome do repositÃ³rio: '$REPO_NAME'..."
          if grep -q "$REPO_NAME" README.md; then
            echo "::notice title=ValidaÃ§Ã£o README.md::âœ… O README.md contÃ©m o nome do repositÃ³rio '$REPO_NAME'."
          else
            echo "::error title=ValidaÃ§Ã£o README.md::âŒ ERRO: O README.md NÃƒO contÃ©m o nome do repositÃ³rio '$REPO_NAME'."
            exit 1 # Falha a etapa do workflow
          fi
        shell: bash

      - name: âœ… Validar tÃ³pico 'development' no README.md
        uses: ./.github/actions/validate-topic-readme
        with:
          topic_to_validate: 'development'

  create_issue_on_failure:
    runs-on: ubuntu-latest
    needs: validar_conteudo_readme 
    if: failure()         
    steps:
      - name: âš™ï¸ Definir variÃ¡veis para o Issue
        id: set_issue_vars 
        run: |
          # Obter informaÃ§Ãµes do contexto do GitHub
          BUILD_NAME="${{ github.workflow }}"
          BUILD_NUMBER="${{ github.run_number }}"
          # github.run_id Ã© um identificador Ãºnico para cada execuÃ§Ã£o de workflow
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # Criar o tÃ­tulo e corpo do issue
          ISSUE_TITLE="ğŸš¨ Falha no Workflow '${BUILD_NAME}' - Build #${BUILD_NUMBER} (${{ github.ref_name }})"
          ISSUE_BODY="Uma execuÃ§Ã£o do workflow **'${BUILD_NAME}'** (Build #${BUILD_NUMBER}) falhou.\n\n" \
                       "**RepositÃ³rio:** `${{ github.repository }}`\n" \
                       "**Branch:** `${{ github.ref_name }}`\n" \
                       "**Commit SHA:** `${{ github.sha }}`\n" \
                       "**Link da ExecuÃ§Ã£o:** [Ver Detalhes da ExecuÃ§Ã£o no GitHub Actions]($RUN_URL)\n\n" \
                       "Por favor, investigue a causa da falha."

          # Exportar as variÃ¡veis para os outputs do step
          echo "issue_title=$ISSUE_TITLE" >> "$GITHUB_OUTPUT"
          echo "issue_body=$ISSUE_BODY" >> "$GITHUB_OUTPUT"

  call_reusable_create_issue:
    needs: create_issue_on_failure
    if: success()
    uses: nathancarrilho/github-actions-reusable/.github/workflows/create-issue.yaml@main
    with:
      issue_title: ${{ steps.set_issue_vars.outputs.issue_title }}
      issue_body: ${{ steps.set_issue_vars.outputs.issue_body }}
      id: created_issue_caller
        # Se precisar do nÃºmero do issue criado:
        # outputs:
        #   issue_number: ${{ steps.created_issue_caller.outputs.issue_number }}